# =============================================================================
# Fluent Bit Configuration for Sibyl MCP Server
# =============================================================================
# Collects logs from Sibyl application and Docker containers, forwards to Loki
# =============================================================================

[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf

# =============================================================================
# INPUTS
# =============================================================================

# Collect Sibyl application logs from file
[INPUT]
    Name              tail
    Path              /var/log/sibyl/*.log
    Parser            json
    Tag               sibyl.app
    Refresh_Interval  5
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On

# Collect Docker container logs
[INPUT]
    Name              tail
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Tag               docker.*
    Refresh_Interval  5
    Mem_Buf_Limit     5MB
    Skip_Long_Lines   On

# =============================================================================
# FILTERS
# =============================================================================

# Add Kubernetes-style metadata (for compatibility)
[FILTER]
    Name                kubernetes
    Match               docker.*
    Kube_URL           unix:///var/run/docker.sock
    Kube_Tag_Prefix     docker.var.log.containers.
    Keep_Log            On
    Merge_Log           On

# Parse Sibyl JSON logs
[FILTER]
    Name                parser
    Match               sibyl.app
    Key_Name            log
    Parser              json
    Reserve_Data        True

# Add hostname and environment labels
[FILTER]
    Name                modify
    Match               *
    Add                 hostname ${HOSTNAME}
    Add                 environment ${ENVIRONMENT:-development}
    Add                 cluster sibyl-cluster

# =============================================================================
# OUTPUTS
# =============================================================================

# Forward all logs to Loki
[OUTPUT]
    Name                loki
    Match               *
    Host                loki
    Port                3100
    Labels              job=fluentbit, hostname=${HOSTNAME}
    Auto_Kubernetes_Labels On
    Line_Format         json
    Retry_Limit         5

# Optional: Output to stdout for debugging
[OUTPUT]
    Name                stdout
    Match               sibyl.*
    Format              json_lines
