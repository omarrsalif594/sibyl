# =============================================================================
# Sibyl HTTP Routing Configuration
# =============================================================================
# This file is included by the main nginx.conf for routing requests
# =============================================================================

# -----------------------------------------------------------------------------
# MCP HTTP Server
# -----------------------------------------------------------------------------
location /mcp/ {
    proxy_pass http://sibyl_mcp_backend/;

    # Proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Timeouts (MCP operations can be slow)
    proxy_connect_timeout 60s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # Buffering
    proxy_buffering off;
    proxy_request_buffering off;

    # Rate limiting
    limit_req zone=api burst=20 nodelay;
    limit_conn conn_limit_per_ip 10;
}

# -----------------------------------------------------------------------------
# REST API
# -----------------------------------------------------------------------------
location /api/ {
    proxy_pass http://sibyl_api_backend/;

    # Proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Timeouts
    proxy_connect_timeout 30s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;

    # Rate limiting
    limit_req zone=api burst=10 nodelay;
    limit_conn conn_limit_per_ip 10;
}

# -----------------------------------------------------------------------------
# Prometheus Metrics (Optional, may want to restrict access)
# -----------------------------------------------------------------------------
location /metrics {
    # Uncomment to restrict to internal IPs only
    # allow 10.0.0.0/8;
    # allow 172.16.0.0/12;
    # allow 192.168.0.0/16;
    # deny all;

    proxy_pass http://prometheus_backend/metrics;

    # Proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # No caching for metrics
    add_header Cache-Control "no-store, no-cache, must-revalidate";
}

# -----------------------------------------------------------------------------
# Root / Default
# -----------------------------------------------------------------------------
location / {
    # Default to REST API
    proxy_pass http://sibyl_api_backend/;

    # Proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Rate limiting
    limit_req zone=per_ip burst=30 nodelay;
    limit_conn conn_limit_per_ip 20;
}

# -----------------------------------------------------------------------------
# Static Error Pages
# -----------------------------------------------------------------------------
error_page 502 503 504 /50x.html;
location = /50x.html {
    root /usr/share/nginx/html;
    internal;
}
